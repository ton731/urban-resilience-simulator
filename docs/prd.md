# 產品需求文件 (PRD): 城市韌性模擬平台 (Urban Resilience Simulation Platform)

- **文件版本:** 1\.1 (擴充版)

- **目標階段:** 最小可行性產品 (MVP)

- **撰寫日期:** 2024年8月22日

- **核心關係人:** \[專案發起人/您的名字\]

## 1\. 專案總覽

### 1\.1. 願景 (Vision)

打造一個強大的、可擴展的城市「數位雙生」(Digital Twin) 模擬平台，用以量化與視覺化天災（初期以颱風風害為主）對城市基礎設施與緊急應變能力的連鎖衝擊。我們的目標是將傳統的「被動式」災害應變思維，轉變為「前瞻性」的風險管理策略，提供一個跨部門協作的共同作戰圖像。最終，本平台將成為輔助政府及企業單位進行防災規劃、資源配置優化與應變演練的決策支援系統，藉由數據驅動的洞察力，建構更具韌性的未來城市。

### 1\.2. 問題陳述 (Problem Statement)

當前的災害防救規劃，往往高度依賴靜態的書面計畫與歷史經驗，這種方式存在顯著的局限性。首先，它缺乏一個動態、量化的工具來預測特定災害情境下，從單一設施失效到整個系統癱瘓的「連鎖效應」(Cascading Effects)。例如，颱風造成的行道樹倒塌，其影響不僅是交通中斷，更會進一步癱瘓緊急救護系統、阻礙民眾避難，但這些連鎖效應的廣度與深度難以在事前精確評估。其次，真實世界的防災演練成本高昂、規模受限，且難以重複測試多種不同情境。本平台旨在解決此問題，提供一個低成本、高效率的沙盒環境，讓決策者能夠在災害發生前，反覆模擬並評估潛在風險，從而制定出更具針對性與有效性的應變計畫。

### 1\.3. 目標使用者 (Target Audience)

深入剖析各類使用者的具體需求：

- **主要使用者:**

   - **地方政府防災單位 (如：災害應變中心指揮官、規劃師):** 需要快速評估災害對轄區的總體衝擊，識別出最脆弱的區域與瓶頸路段，以便預先部署救援人力與機具。

   - **都市規劃部門:** 在進行城市規劃或道路設計時，可利用本平台評估不同行道樹種植方案的長期風險，輔助其建立更安全的城市綠化政策。

   - **基礎設施管理機構 (如：林務局、工務局):** 需要一個工具來識別出高風險的樹木或路段，以作為日常維護（如修剪）和災前預防性移除的優先級排序依據。

- **次要使用者:**

   - **災害管理研究學者:** 可利用此平台作為研究工具，測試不同的災害模型或應變策略，並發表量化研究成果。

   - **企業風險管理部門 (如：物流公司、保全公司):** 可模擬災害對其營運路線的影響，提前規劃替代路徑，確保業務連續性。

   - **社區防災組織:** 可透過簡化版的模擬結果，對社區居民進行防災教育，告知其社區內的潛在風險點及最佳避難路徑。

### 1\.4. MVP 範圍定義 (Scope of MVP)

第一階段的 MVP 將專注於實現一個完整的核心模擬流程，從資料生成、災害模擬、衝擊分析到視覺化呈現，以此驗證整個概念的可行性與核心價值。

- **範圍內 (In-Scope):**

   1. **虛擬城市生成:** 程序化生成包含道路網路、隨機分佈的樹木、固定數量的救護站與避難所的虛擬城市地圖，作為模擬的基礎。

   2. **靜態災害事件:** 基於簡化機率模型的靜態樹木倒塌模擬。模擬將是一個「快照」，呈現災害在某一瞬間造成的最大物理破壞。

   3. **精細化路網分析:** 考量不同車輛（如機車、救護車）的通行寬度需求，進行道路中斷分析。這對於評估大型救援車輛的可及性至關重要。

   4. **核心衝擊評估:** 計算並比較災害前後，救護車的服務範圍（以等時圈呈現）與民眾前往避難所的最佳路徑變化，量化災害的實際影響。

   5. **整合式視覺化介面:** 透過互動式地圖與數據儀表板，全面且直觀地呈現模擬的每一個環節與最終分析結果。

- **範圍外 (Out-of-Scope):**

   1. **動態天氣模型:** 不模擬具有移動路徑、風眼結構及各地風速差異的動態颱風。所有模擬均基於一個全域統一的災害強度參數。

   2. **動態時間演進:** 不模擬災害發生後隨時間變化的情況，例如搶修隊伍清除路障的過程。整個模擬是「災害前 vs. 災害後」的靜態對比。

   3. **多樣化基礎設施:** 除樹木外，暫不模擬其他可能受損的基礎設施，如電線桿、交通號誌、變電箱等。

   4. **複雜人類行為:** 不模擬民眾在避難過程中的複雜行為，如恐慌、資訊不足導致的繞路、交通壅塞等。所有路徑規劃均基於理想化的「最佳路徑」。

   5. **真實圖資匯入:** MVP 階段不支援匯入真實世界的圖資，但整體系統架構在設計時必須預留此功能的介面與擴充彈性。

   6. **互動式決策演練:** 使用者僅能觀看模擬結果，無法在模擬過程中進行干預，例如手動派遺搶修隊伍。

## 2. 系統架構與模組劃分

本平台 MVP 將由以下四個核心模組構成。此架構設計旨在實現「高內聚、低耦合」的原則，讓各模組職責分明，可獨立開發與測試，並透過定義好的數據介面（API）進行數據交換，確保未來新增功能或替換模型時，對系統的影響降至最低。

1. **模組一：世界合成器 (World Synthesizer)**

   - **職責:** 負責程序化生成所有模擬所需的基礎地理與設施數據，建立一個數位化的虛擬城市環境。它是一切模擬的起點，產出一個結構化的「世界狀態」數據集。

   - **輸入:** 配置文件 (Config File) 中的各項生成參數。

   - **輸出:** 一個包含地圖、道路網路圖、所有物件（樹木、設施）及其屬性的初始「世界狀態」(Initial World State) 物件。

2. **模組二：模擬引擎 (Simulation Engine)**

   - **職責:** 平台的核心計算單元。接收基礎世界數據與災害參數，模擬物理世界的變化（樹木倒塌），並基於這些變化，更新核心網路（道路系統）的通行能力。

   - **輸入:** 初始「世界狀態」物件、災害參數。

   - **輸出:** 一個包含倒塌事件清單的「災害後世界狀態」(Post-Disaster World State) 物件，以及一個更新後的道路網路通行圖 (Updated Network Graph)。

3. **模組三：衝擊分析模組 (Impact Analysis Module)**

   - **職責:** 應用層模組。將模擬引擎產出的底層路網分析結果，轉化為對目標使用者有意義的高階指標，回答「所以呢？」(So What?) 的問題。

   - **輸入:** 災害前後的世界狀態與路網圖。

   - **輸出:** 一系列量化的衝擊指標 (KPIs) 與用於視覺化的地理數據（如等時圈多邊形）。

4. **模組四：視覺化與控制介面 (Visualization & Control Interface)**

   - **職責:** 使用者與平台互動的前端。以圖形化方式呈現所有數據與分析結果，並提供使用者操作模擬流程的控制項。

   - **輸入:** 各模組產出的所有數據。

   - **輸出:** 渲染在使用者螢幕上的圖形介面。

## 3. 詳細功能需求

### 3.1. 模組一：世界合成器 (World Synthesizer)
**WS-1.1：程序化地圖生成**
- 能夠生成一個預設大小的二維網格地圖，並定義地理邊界。
- 地圖上包含隨機但符合邏輯的道路網路，應包含少量主幹道（較寬、貫穿地圖）與大量次要道路（較窄、連接主幹道），並自然形成十字路口。
- 道路應以圖論的數據結構（節點Nodes、邊Edges）儲存，每條邊（路段）具備屬性：唯一ID、寬度(公尺)、車道數、單向/雙向標記。


**WS-1.2：樹木物件生成**
- 沿著已生成的道路邊（Edges）兩側，以一定的間距和隨機偏移量，放置樹木物件。
- 每棵樹是一個獨立的數據物件，必須具備屬性：唯一ID、地理座標 (x, y)、**脆弱度等級 (I, II, III)**、樹高(公尺)、樹幹寬度(公尺)。
- 脆弱度等級應依照配置文件中的預設比例隨機分配 (例如: `{"level_I": 0.1, "level_II": 0.3, "level_III": 0.6}`)，以模擬不同區域的樹木健康狀況。


**WS-1.3：關鍵設施生成**
- 在地圖上隨機選擇道路網路中的節點（Nodes）作為設施位置，確保其與主要交通網路相連。
- 生成指定數量的**救護車起點**（如消防分隊、醫院）與**避難所**。
- 設施同樣是獨立數據物件，具備屬性：唯一ID、地理座標 (x, y)、類型（救護站/避難所）、容量（避難所適用）。


**WS-1.4：配置彈性**
- 上述所有生成過程的參數，應全部集中在一個外部的配置文件 (例如 `config.json` 或 `config.yaml`) 中進行管理，以便於快速調整模擬情境而無需修改程式碼。
- **配置範例:** `{"map_size": [2000, 2000], "road_density": 0.7, "tree_count": 8000, "ambulance_stations": 5, "shelters": 10}`。


**WS-1.5：人口網格生成**
- 在地圖上疊加一層網格（Grid），每個網格單元內隨機分配一個人口數值，以模擬人口密度分佈。人口密集區應傾向於分佈在道路網路密集的區域。
- 此數據將作為**避難所可及性分析 (IA-3.2)** 的重要輸入。



### 3.2. 模組二：模擬引擎 (Simulation Engine)
**SE-2.1**：（子模組）災害模擬**
- 輸入：一個代表整體災害強度的**均值風力參數**（初期可為抽象值，如 1-10 級）。
- 核心邏輯：此為隨機過程，每次執行模擬結果可能不同。遍歷地圖上所有樹木，根據其**脆弱度等級**，以配置文件中預設的機率判斷是否倒塌。
- **I 級 (高風險):** 80% 機率倒塌。
- **II 級 (中風險):** 50% 機率倒塌。
- **III 級 (低風險):** 10% 機率倒塌。
- 倒塌方向：對於確定倒塌的樹木，隨機生成一個 0-360 度的倒塌方向角。
- 輸出：一份包含所有倒塌樹木及其倒塌方向的**災害事件清單**。


**SE-2.2：（子模組）路網分析**
- 輸入：原始道路網路圖、災害事件清單、**交通工具配置文件**。
   - 道路阻斷計算：
      1. 對於每個倒塌事件，根據樹木的座標、樹高（作為倒塌矩形的長度）、樹幹寬度及倒塌方向，在二維空間中計算出其形成的**阻礙多邊形 (blockage polygon)**。
      2. 將此多邊形與其所在的道路多邊形進行幾何交集運算，精確計算出該路段的**剩餘可通行寬度**。
   - 路徑規劃：
      1. 實現一個高效的標準路徑規劃演算法（如 A\* 或 Dijkstra），演算法的邊權重（cost）應基於 `路段長度 / 道路速限`。
      2. 當為特定交通工具（如寬度為2.5公尺的救護車）計算兩點間路徑時，演算法在遍歷路網時，必須動態檢查該交通工具的寬度是否小於路段的**剩餘可通行寬度**。若否，則該路段的通行成本應設為無窮大（即視為不可通行）。
- 輸出：一個API，在給定起點、終點和交通工具類型後，能夠即時回傳**最佳路徑**的地理座標序列及預估的**通行時間**（單位：秒）。


### 3.3. 模組三：衝擊分析模組 (Impact Analysis Module)
**IA-3.1：救護車服務範圍分析**
- **災害前分析：** 以每個救護車起點為中心，利用**路網分析模組 (SE-2.2)**，向外擴展計算，生成精確的服務等時圈 (isochrones) 多邊形數據（例如，分別計算 5, 10, 15 分鐘可抵達的所有區域）。
- **災害後分析：** 在災害事件發生後，使用更新後的受阻路網，以完全相同的邏輯，重新計算上述等時圈資料。
- **指標計算：** 自動比較災害前後的數據，計算出如「15分鐘黃金救援時間內可達區域面積縮減百分比」、「全地圖平均反應時間增加秒數」、「服務盲區（災後無法抵達區域）面積」等。


**IA-3.2：避難所可及性分析**- **災害前分析：** 以地圖上的每個**人口網格 (WS-1.5)** 的中心點為起點，計算其前往**拓撲距離最近的避難所**的最佳路徑與所需時間（可區分步行與駕車模式）。
- **災害後分析：** 在災害事件發生後，重新計算上述路徑與時間。若原來的最近避難所已無法到達，則自動尋找次近的可用避難所。
- **指標計算：** 綜合人口數據，計算「平均避難時間增加比例」、「受困人口估算（無法在指定時間內抵達任何避難所的人口總數）」、「各避難所災後潛在收容壓力（分流後各避難所對應的總人口數）」等 KPIs。



### 3.4. 模組四：視覺化與控制介面 (Visualization & Control Interface)
**VI-4.1：主畫面：互動地圖**
- 以 2D 俯視視角，使用高效能的渲染函式庫，流暢地呈現由**世界合成器 (WS)** 生成的所有地圖元素（道路、建築區域）。
- 樹木應以不同顏色或圖標（如 綠/黃/紅 圓點）清晰標示其脆弱度等級。滑鼠懸停在樹木上時，應顯示包含其詳細屬性（ID, 脆弱度, 高度, 寬度）的工具提示框。
- 災害模擬後，在地圖上以半透明的矩形，精確繪製出倒塌的樹木及其影響範圍（阻礙多邊形）。
- 能夠將**衝擊分析模組 (IA)** 的結果以可開關的圖層方式疊加顯示，如用不同透明度的顏色區域表示救護車等時圈，用高亮動畫線條表示特定避難路徑。
- 提供基本的地圖操作功能：流暢的平移、滾輪縮放。


**VI-4.2：控制面板**
- 提供一個佈局清晰、操作直觀的控制面板，包含以下核心操作按鈕：
   1. 「(1) 生成新地圖」：觸發 **WS** 模組，並清空當前所有模擬結果。
   2. 「(2) 執行災害模擬」：觸發 **SE** 與 **IA** 模組，並更新地圖與儀表板。
- 提供一組圖層切換的核取方塊 (checkboxes)，讓使用者可以自由組合開/關不同的視覺化圖層（如：樹木脆弱度、倒塌樹木、救護車服務範圍(災前)、救護車服務範圍(災後)、避難路徑等）。


**VI-4.3：資訊儀表板 (Dashboard)**
- 在地圖旁（或可拖動的浮動視窗中）設置一個儀表板區域。
- 以數字、儀表盤、長條圖、圓餅圖等豐富且易於理解的方式，即時顯示由**衝擊分析模組 (IA)** 計算出的關鍵指標 (KPIs)。
- **顯示範例：** 「道路中斷總長度(公里)」、「受影響樹木總數（依脆弱度分類）」、「15分鐘內服務範圍覆蓋率（災害前後對比長條圖）」、「平均避難時間（災害前後對比儀表盤）」、「預估受困人口數」等。
- 所有圖表應具備基礎互動性，如滑鼠懸停顯示確切數值。 | 

